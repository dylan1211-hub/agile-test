<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Indoor Route Arrow Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script type='text/javascript'src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <link rel="stylesheet" href="./route_arrow.css">

</head>

<body style="margin: 0px; overflow: hidden;">

	<!--<input type="checkbox" name="" id="sideMenu-active" >

		<div  id="map" class="sideMenu">
			<iframe id="mapFrame" name="mapFrame"  src="https://d5e2-140-116-47-123.ngrok-free.app/rtls/app/zh-tw/map?enablePanel=false">
			<script>
			// Only for local development
			headers['ngrok-skip-browser-warning'] = 'skip-browser-warning';
			</script>
			</iframe>
			<label for="sideMenu-active" id="label" class="label">
				<p class="fas">◀</p>
			</label>

			<div>
				<button type="button" onclick="locateItemFunc()" id="locate">
					<img id ="lb" src="https://dylan1211-hub.github.io/UWB-test/assets/position.png" border="0"/>
				</button>
			</div>
		</div>
		
	
	<script> //接室內地圖
		var mapWindow = document.getElementById('mapFrame').contentWindow;
	  
		let configureAuthToken = function () {
			mapWindow.postMessage({type: 'request', cmd: 'configure', data: {key: "authentication", value: {apiKey: "prod0159f50204644026939caac9876724a3", appId: "ncku_geo"}}}, '*');
		}
		
		function locateItemFunc() {
			mapWindow.postMessage({type: 'request', cmd: 'locateItem', data: {itemUid: "F2E5", setCenter: true, setCurrent: false}}, '*');
		}
	  
		function receivedMessageFromChannel(e) {
			if (e.source === e.target) { 
				console.warn("Message ignored (e.source == e.target):", e);
				return;
			}
	  
			const msg = e.data;
			let srcWindow = e.source;
			if (msg.type === 'info') {
				
			 switch (msg.cmd) {
				case 'ready':
				configureAuthToken();
				break;
				default:
				break;
				}
			} 
		}
	  
		window.addEventListener("message", receivedMessageFromChannel);
	  
	</script>-->

    <a-scene cursor="rayOrigin: mouse; fuse: true: fuseTimeout: 0;" raycaster="objects: .object;" id="scene"
        vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;">  

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 25 0" animation-mixer id="L1" ></a-entity>
        <a-text class="arrow" value="往樓梯方向" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 60 0" animation-mixer id="L4" ></a-entity>
        <a-text class="arrow" value="向左轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 240 0" animation-mixer id="L5" ></a-entity>
        <a-text class="arrow" value="向右轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 330 0" animation-mixer id="L6" ></a-entity>
        <a-text class="arrow" value=" " scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 240 0" animation-mixer id="L7" ></a-entity>
        <a-text class="arrow" value="向右轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 330 0" animation-mixer id="L8" ></a-entity>
        <a-text class="arrow" value=" " scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 -30 -28" animation-mixer id="L9" ></a-entity>
        <a-text class="arrow" value="請上樓梯" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 210 -28" animation-mixer id="L10" ></a-entity>
        <a-text class="arrow" value="請上樓梯" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 330 0" animation-mixer id="L11" ></a-entity>
        <a-text class="arrow" value="向左轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 150 0" animation-mixer id="L12" ></a-entity>
        <a-text class="arrow" value="向右轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 240 0" animation-mixer id="L13" ></a-entity>
        <a-text class="arrow" value=" " scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 300 0" animation-mixer id="L14" ></a-entity>
        <a-text class="arrow" value=" " scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 150 0" animation-mixer id="L15" ></a-entity>
        <a-text class="arrow" value="向右轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 330 0" animation-mixer id="L16" ></a-entity>
        <a-text class="arrow" value="向左轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 240 0" animation-mixer id="L17" ></a-entity>
        <a-text class="arrow" value="直走到底" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 150 0" animation-mixer id="L18" ></a-entity>
        <a-text class="arrow" value="向右轉" scale="2 2 2" align="center"></a-text>

        <a-entity class="arrow" gltf-model="./arrow.gltf" scale="0.1 0.1 0.1" rotation="0 330 0" animation-mixer id="L19" ></a-entity>
        <a-text class="arrow" value="向左轉" scale="2 2 2" align="center"></a-text>

        <a-camera id=camera rotation-reader fov="80"  ></a-camera>
    </a-scene>

    <script type="module">
		import LatLon from 'https://cdn.jsdelivr.net/npm/geodesy@2.3.0/latlon-ellipsoidal-vincenty.js'; //匯入橢球距離的計算工具程式
		
		//---全域變數---
		//API網址 (80 port: ngrok http 80)
		function Run(){	const TrackAPI = "https://dec4-140-116-47-115.ngrok-free.app/TrackAPI.php";

            var position;
            
            //AR內容位置
            let objectPosition = [{"x":120.2199256228 ,"y":22.9986691059228,"z":15.334},  
            {"x":120.219909411719,"y":22.9986824847103 ,"z":15.334},
            {"x":120.219994938967,"y":22.998675280748,"z":15.334},
            {"x":120.220021771044,"y":22.9986963780652,"z":15.334},
            {"x":120.220041336101,"y":22.9987226210649,"z":15.334},
            {"x":120.2200273,"y":22.99874612,"z":15.334},
            {"x":120.219922268756,"y":22.9987025528891,"z":15.934},
            {"x":120.219960280866,"y":22.9987149025361,"z":17.334},
            {"x":120.220017858033,"y":22.9987308541619,"z":23.334},
            {"x":120.2200222,"y":22.99870616,"z":23.334},
            {"x":120.22003742309,"y":22.9987473203542,"z":23.334},
            {"x":120.220029,"y":22.99875915,"z":23.334},
            {"x":120.220060342156,"y":22.9987406309638,"z":23.334},
            {"x":120.22007090665,"y":22.99875175305,"z":23.334},
            {"x":120.220135807375,"y":22.9987437183748,"z":23.334},
            {"x":120.2202006,"y":22.99873664,"z":23.334},
            {"x":120.22020017125,"y":22.99874821465,"z":23.334},];

            
            //---主要功能: 取得姿態、位置等參數控制AR內容渲染狀況---
            //watch position for indoor (每一秒呼叫一次後端API，從GIPS server獲取最新一筆定位軌跡，存入物件position)
            jQuery(document).ready(function(){
                window.addEventListener('deviceorientation', function(event) { //get azimuth
                    //處理方位角
                    let head = event.webkitCompassHeading; //獲取羅盤資料(iOS限定) //手機-z軸向(朝前)相對於N軸向之順時針角度
                    if (head == undefined){ head = 0; } //無羅盤資料則預設朝向正北
                    let theta = -(head-180-90); //N軸轉向手機x軸向(朝右)的逆時針角度
                    let theta_rad = theta * Math.PI /180; //換成弧度
                    
                    //處理位置之計算
                    //let height = 31.634; //假設固定於2樓移動
                    //let userHeight = height + 1.3;

                    $.getJSON( TrackAPI, function (data){
                        let userHeight = data.z + 14.728;
                        position = {coords:{longitude: data.x, latitude: data.y, altitude: userHeight}}; //用戶即時位置座標
                        SetLocation("text", theta_rad, position, objectPosition, "arrow");
                        SetLocation("entity", theta_rad, position, objectPosition, "arrow");  
                    });


                    setInterval(function() { //定時讀取軌跡中下一筆資料，並且重設模型位置
                        $.getJSON( TrackAPI, function(data){
                            let userHeight = data.z + 14.728;
                            position = {coords:{longitude: data.x, latitude: data.y, altitude: userHeight}}; //用戶即時位置座標
                            SetLocation("text", theta_rad, position, objectPosition, "arrow");
                            SetLocation("entity", theta_rad, position, objectPosition, "arrow"); 
                        });
                    }, 1000);

                }, {once: true}); //取得網頁就緒當下之方位角，且不隨每次的位置更新重複執行
            });
            //GetSwitch();
                    
            //設定各模型相對於所在即時位置的高及位置
            function SetLocation(type, degree, position, ancpos, classtype){ //type: 實體類型, degree: 啟動時裝置方位角, position: 用戶位置座標, ancpos: AR內容座標
                let target = document.querySelectorAll('a-'+type+'.'+classtype);
                if (target.length!=0 && ancpos.length!=0){
                    for(let j=0; j<ancpos.length; j++){ 
                        let H = ancpos[j].z - position.coords.altitude;
                        let user = new LatLon(position.coords.latitude, position.coords.longitude);
                        let E = new LatLon(position.coords.latitude, ancpos[j].x).distanceTo(user);
                        let N = new LatLon(ancpos[j].y, position.coords.longitude).distanceTo(user);
                        if (ancpos[j].x-position.coords.longitude < 0){ E = -E;}
                        if (ancpos[j].y-position.coords.latitude < 0){ N = -N;}
                        if (type=="text"){
                        	target[j].setAttribute("look-at", {x: 0, y: 0, z: 0});
                        	H = ancpos[j].z + 0.5 - position.coords.altitude;
                        }
                        let z = Math.cos(degree)*E + Math.sin(degree)*N;
                        let x = Math.cos(degree)*N - Math.sin(degree)*E; //換算至手機相機局部坐標系中(公尺)
        

                        let target_att = document.createAttribute('position');
                        target_att.value = x+" "+H+" "+z;
                        target[j].setAttributeNode(target_att);
                        
                    }
                }
            };

    	};
   		Run();

		/*function GetSwitch(){
            let checkbox = document.querySelector("#myonoffswitch");
            checkbox.addEventListener('change',function(){
                let scene = document.getElementById('scene');
                if(this.checked){
                    
                    for(let r=0;r<6;r++){
                        let right = document.createElement('a-entity');
                        right.setAttribute('class','computer_room');
                        right.setAttribute('gltf-model','https://dylan1211-hub.github.io/UWB-test/assets/computer_and_table_2.glb');
                        right.setAttribute('scale','0 0 0');
						right.setAttribute('rotation','0 -45 0');
                        right.setAttribute('animation-mixer');
                        right.setAttribute('id','object');
                        scene.appendChild(right);
                    };
                    for(let l=0;l<5;l++){
                        let left = document.createElement('a-entity');
                        left.setAttribute('class','computer_room');
                        left.setAttribute('gltf-model','https://dylan1211-hub.github.io/UWB-test/assets/computer_and_table.glb');
                        left.setAttribute('scale','0 0 0');
						left.setAttribute('rotation','0 -45 0');
                        left.setAttribute('animation-mixer');
                        left.setAttribute('id','object');
                        scene.appendChild(left);
                    };

                    let floor = document.createElement('a-entity');
                    floor.setAttribute('class','computer_room');
                    floor.setAttribute('material','color: #7B7B7B; transparent: true; opacity: 0');
               		floor.setAttribute('geometry','primitive: box; depth: 15.2 ;width: 8.6; height:0.01');
					floor.setAttribute('rotation','0 -45 0');
                    floor.setAttribute('animation-mixer');
                    floor.setAttribute('id','object');
					scene.appendChild(floor);



                    Run();

                    
                }else{
                    console.log("not display");
					scene.removeChild(document.getElementById('user'));	
                    for(let i=0;i<13;i++){
                    scene.removeChild(document.getElementById('object'));
                    }
            }})
        }*/

	</script>

</body>

</html>